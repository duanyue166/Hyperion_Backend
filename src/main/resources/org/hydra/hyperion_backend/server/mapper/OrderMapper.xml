<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.hydra.hyperion_backend.server.mapper.OrderMapper">
    <insert id="addSoldGoods">
        insert into sold_goods (order_id, goods_id, quantity, unit_price)
        values
        <foreach collection='soldGoodsDetails' item='item' separator=','>
            (#{orderId}, #{item.goodsId}, #{item.quantity}, #{item.price}*#{item.discount})
        </foreach>
    </insert>

    <select id="getSoldGoodsDetails" resultType="org.hydra.hyperion_backend.pojo.vo.SoldGoodsDetailVo">
        select g.id      as goods_id,
               t.quantity,
               g.user_id as mer_id,
               g.cover_url,
               g.price,
               g.discount
        from trolley t
                 join goods g
                      on t.goods_id = g.id
        where t.user_id = #{userId}
          and g.state = 'ACTIVE'
          and t.goods_id in
        <foreach collection="goodsIdList" item="goodsId" open="(" close=")" separator=",">
            #{goodsId}
        </foreach>
    </select>
    
    <delete id="deleteTrolley">
        delete from trolley
        where user_id = #{userId}
        and goods_id in
        <foreach collection="goodsIdList" item="goodsId" open="(" close=")" separator=",">
            #{goodsId}
        </foreach>
    </delete>

    <select id="cList" resultType="org.hydra.hyperion_backend.pojo.vo.OrderListItemVo">
        select id, state, create_time, payment, cover_url
        from `order`
        where con_id = #{userId}
        <if test="state != null">
            and state = #{state}
        </if>
    </select>

    <select id="mList" resultType="org.hydra.hyperion_backend.pojo.vo.OrderListItemVo">
        select id, state, create_time, payment, cover_url
        from `order`
        where mer_id = #{userId}
        <if test="state != null">
            and state = #{state}
        </if>
    </select>

    <update id="updateState">
        update `order`
        set state = #{state}
        where id = #{orderId}
        <if test='state == "CONFIRMED"'>
            and state = 'PLACED' and con_id = #{userId}
        </if>
        <if test='state == "SHIPPED"'>
            and state = 'CONFIRMED' and mer_id = #{userId}
        </if>
        <if test='state == "COMPLETE"'>
            and state = 'SHIPPED' and con_id = #{userId}
        </if>
    </update>

    <update id="review">
        update sold_goods
        set review = #{score}
        where order_id = #{orderId}
        and goods_id = #{goodsId};

        set @quantity = (select quantity
        from sold_goods
        where order_id = #{orderId}
        and goods_id = #{goodsId});

        <if test="score == 1">
            update goods set pos_count = pos_count + @quantity where id = #{goodsId};
        </if>

        <if test="score == -1">
            update goods set neg_count = neg_count + @quantity where id = #{goodsId};
        </if>
    </update>
</mapper>
